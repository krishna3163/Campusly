name: Build & Deploy Campusly

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        env:
          VITE_INSFORGE_BASE_URL: ${{ secrets.VITE_INSFORGE_BASE_URL }}
          VITE_INSFORGE_ANON_KEY: ${{ secrets.VITE_INSFORGE_ANON_KEY }}
        run: npm run build

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: dist/
          retention-days: 30

  build-apk:
    name: Build Android APK (Capacitor)
    needs: build-web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: dist/

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Initialize Android project
        run: npx @capacitor/cli add android

      - name: Sync Capacitor
        run: npx @capacitor/cli sync android

      - name: Build Android App (APK)
        working-directory: ./android
        run: ./gradlew assembleDebug

      - name: Copy APK to workspace
        run: cp android/app/build/outputs/apk/debug/app-debug.apk ./campusly-release.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: campusly-apk
          path: campusly-release.apk
          retention-days: 90
          if-no-files-found: warn

  create-release:
    name: Create GitHub Release
    needs: [build-web, build-apk]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: campusly-apk
          path: ./release/

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: ./web-dist/

      - name: Create release tag
        run: echo "RELEASE_TAG=v0.1.0-$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Campusly ${{ env.RELEASE_TAG }}"
          body: |
            ## ðŸš€ Campusly Release

            ### What's New
            - Trust, Reporting & Social Graph System
            - Bug Report System with admin dashboard
            - Global Error Auto-Reporting
            - Friend Request System with social graph
            - First-Time User Onboarding Suggestions
            - Developer Profile Page
            - Settings Expansion (Help & Support)

            ### Downloads
            - **APK**: Download the Android app below
            - **Web**: Deploy the `web-dist` artifact to any static host

            ### Checksums
            Built from commit: ${{ github.sha }}
          files: |
            ./release/*
          draft: false
          prerelease: true
